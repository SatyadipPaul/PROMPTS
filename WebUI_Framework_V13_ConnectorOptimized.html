<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Diagram WebApp v3.3 (Boundary Connectors - Improved Elbow)</title>
    <style>
        /* CSS is identical to WebUI_Framework_V11 / Pro Diagram WebApp v3.1 (Full Icons & Selection Fix) */
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; background-color: #f0f2f5; overflow: hidden; }
        #toolbar { background-color: #2c3e50; padding: 8px 10px; color: white; display: flex; gap: 5px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; flex-wrap: wrap; font-size: 11px;}
        #toolbar button, #toolbar select, #toolbar input[type="color"] { padding: 5px 8px; background-color: #4a6278; color: white; border: 1px solid #566f89; border-radius: 4px; cursor: pointer; font-size: 11px; vertical-align: middle; }
        #toolbar select { background-color: #3b5063; }
        #toolbar input[type="color"] { padding: 1px 2px; width: 28px; height: 24px; box-sizing: border-box; }
        #toolbar button:hover, #toolbar select:hover, #toolbar input[type="color"]:hover { background-color: #5dade2; border-color: #7bc0ea; }
        #toolbar button:disabled { background-color: #3a4b5a; color: #777; cursor:not-allowed; border-color: #4a5c6d;}
        #toolbar button.active { background-color: #5dade2; box-shadow: inset 0 0 5px rgba(0,0,0,0.3); }
        #toolbar input[type="text"] { padding: 5px; border-radius: 4px; border: 1px solid #ccc; min-width: 70px; font-size: 11px; vertical-align: middle;}
        #toolbar label { margin-left: 2px; margin-right: 1px; font-size: 11px; vertical-align: middle;}
        #diagram-area { flex-grow: 1; position: relative; background-color: #ecf0f1; overflow: auto; }
        #diagram-canvas { width: 3000px; height: 3000px; background-image: linear-gradient(to right, #dde1e3 1px, transparent 1px), linear-gradient(to bottom, #dde1e3 1px, transparent 1px); background-size: 20px 20px; }

        .shape-visual { stroke-width: 1.5px; }
        .shape-outline { fill: transparent; stroke-width: 2px; }
        .main-text { text-anchor: middle; dominant-baseline: middle; pointer-events: none; user-select: none; fill: #2c3e50; font-size: 12px; }
        .main-text.on-dark-shape { fill: white; }
        .icon-glyph { text-anchor: middle; dominant-baseline: central; pointer-events: none; user-select: none; font-size: 28px; fill: #2c3e50; }
        .flow-shape-icon { font-size: 18px; fill: #FFF; pointer-events: none; text-anchor: middle; dominant-baseline:central; }
        .flow-shape-icon.dark { fill: #34495e; }
        .icon-label { text-anchor: middle; dominant-baseline: hanging; pointer-events: none; user-select: none; font-size: 11px; fill: #34495e; }
        .free-text-visual { font-size: 14px; fill: #333; pointer-events: all; cursor: move; dominant-baseline: middle; }
        .connector { stroke: #566f89; stroke-width: 2.5px; fill: none; marker-end: url(#arrowhead); stroke-dasharray: 10, 6; animation: marchingAnts 0.7s linear infinite; }
        @keyframes marchingAnts { to { stroke-dashoffset: -16; } }
        .selected-outline { stroke: #f39c12 !important; stroke-width: 2.5px !important; fill: rgba(243, 156, 18, 0.08) !important; stroke-dasharray: 6, 3 !important; }
        .selected-filled-shape { stroke: #f39c12 !important; stroke-width: 3px !important; }
        .selected-connector { stroke: #f39c12 !important; marker-end: url(#arrowhead-selected) !important; }
        #selection-rectangle { fill: rgba(46, 134, 193, 0.2); stroke: rgba(46, 134, 193, 0.6); stroke-width: 1px; stroke-dasharray: 3,2;}
    </style>
</head>
<body>
    <div id="toolbar">
        <button id="tool-undo" title="Undo last action (Ctrl+Z)">â†©ï¸ Undo</button>
        <button id="tool-redo" title="Redo last undone action (Ctrl+Y)">â†ªï¸ Redo</button>
        <span style="margin:0 5px; border-left:1px solid #566f89; height: 20px;"></span>
        <button id="tool-select" title="Select Tool">Select</button>
        <button id="tool-resize" title="Resize Tool">Resize</button>
        <label for="shape-type-select">Shape:</label>
        <select id="shape-type-select" title="Base or Flow Diagram shape.">
            <option value="">-- Geometric --</option>
            <option value="rect">Rectangle (Process)</option><option value="circle">Circle (Connector/Link)</option>
            <option value="db">Database / Storage</option><option value="diamond">Diamond (Decision)</option>
            <option value="parallelogram">Parallelogram (Input/Output)</option><option value="oval">Oval (Start/End)</option>
            <option value="document">Document</option><option value="predefinedProcess">Predefined Process</option>
            <option value="manualInput">Manual Input</option><option value="manualOperation">Manual Operation</option>
            <option value="internalStorage">Internal Storage</option>
        </select>
        <label for="icon-type-select">Icon (Standalone):</label>
        <select id="icon-type-select" title="Choose a standalone icon.">
            <option value="">-- Icon --</option>
            <optgroup label="Common"><option value="user" data-glyph="ğŸ§‘">ğŸ§‘ User</option><option value="chatbot" data-glyph="ğŸ¤–">ğŸ¤– Chatbot</option><option value="prompt" data-glyph="ğŸ“–">ğŸ“– Prompt</option><option value="brain" data-glyph="ğŸ§ ">ğŸ§  Brain</option><option value="code" data-glyph="ğŸ’»">ğŸ’» Code/PC</option><option value="file" data-glyph="ğŸ“„">ğŸ“„ File</option><option value="cloud" data-glyph="â˜ï¸">â˜ï¸ Cloud</option></optgroup>
            <optgroup label="Activities & Sports"><option value="soccer" data-glyph="âš½">âš½ Soccer</option><option value="basketball" data-glyph="ğŸ€">ğŸ€ Basketball</option><option value="airplane" data-glyph="âœˆï¸">âœˆï¸ Airplane</option><option value="rocket" data-glyph="ğŸš€">ğŸš€ Rocket</option><option value="guitar" data-glyph="ğŸ¸">ğŸ¸ Guitar</option><option value="books" data-glyph="ğŸ“š">ğŸ“š Books</option></optgroup>
            <optgroup label="Objects"><option value="bulb" data-glyph="ğŸ’¡">ğŸ’¡ Bulb</option><option value="key" data-glyph="ğŸ”‘">ğŸ”‘ Key</option><option value="lock" data-glyph="ğŸ”’">ğŸ”’ Lock</option><option value="email" data-glyph="âœ‰ï¸">âœ‰ï¸ Email</option><option value="phone" data-glyph="ğŸ“">ğŸ“ Phone</option><option value="alarm" data-glyph="â°">â° Alarm</option><option value="gear" data-glyph="âš™ï¸">âš™ï¸ Gear/Setting</option><option value="hammer" data-glyph="ğŸ”¨">ğŸ”¨ Hammer</option><option value="moneybag" data-glyph="ğŸ’°">ğŸ’° Moneybag</option></optgroup>
            <optgroup label="Symbols"><option value="check" data-glyph="âœ…">âœ… Check</option><option value="cross" data-glyph="âŒ">âŒ Cross</option><option value="warning" data-glyph="âš ï¸">âš ï¸ Warning</option><option value="question" data-glyph="â“">â“ Question</option><option value="exclamation" data-glyph="â—">â— Exclamation</option><option value="info" data-glyph="â„¹ï¸">â„¹ï¸ Info</option><option value="copyright" data-glyph="Â©ï¸">Â©ï¸ Copyright</option><option value="registered" data-glyph="Â®ï¸">Â®ï¸ Registered</option><option value="tm" data-glyph="â„¢ï¸">â„¢ï¸ TM</option><option value="arrow_right" data-glyph="â¡ï¸">â¡ï¸ Arrow Right</option><option value="arrow_left" data-glyph="â¬…ï¸">â¬…ï¸ Arrow Left</option><option value="arrow_up" data-glyph="â¬†ï¸">â¬†ï¸ Arrow Up</option><option value="arrow_down" data-glyph="â¬‡ï¸">â¬‡ï¸ Arrow Down</option></optgroup>
            <optgroup label="System Architecture"><option value="server_generic" data-glyph="ğŸ–¥ï¸">ğŸ–¥ï¸ Server (Generic)</option><option value="database_generic" data-glyph="ğŸ’¾">ğŸ’¾ Database (Generic)</option><option value="web_server" data-glyph="ğŸŒ">ğŸŒ Web Server</option><option value="app_server" data-glyph="ğŸ“±">ğŸ“± App Server</option><option value="cache" data-glyph="ğŸ’¨">ğŸ’¨ Cache</option><option value="load_balancer_icon" data-glyph="âš–ï¸">âš–ï¸ Load Balancer</option><option value="firewall_icon" data-glyph="ğŸ§±">ğŸ§± Firewall</option><option value="api_gateway" data-glyph="ğŸšª">ğŸšª API Gateway</option><option value="message_queue" data-glyph="ğŸ“¨">ğŸ“¨ Message Queue</option><option value="router" data-glyph="â†”ï¸">â†”ï¸ Router</option><option value="switch_device" data-glyph="ğŸ”€">ğŸ”€ Switch</option><option value="laptop" data-glyph="ğŸ’»">ğŸ’» Laptop/Client</option><option value="mobile_client" data-glyph="ğŸ“±">ğŸ“± Mobile Client</option><option value="storage_bucket" data-glyph="ğŸª£">ğŸª£ Storage Bucket</option><option value="cdn" data-glyph="ğŸŒ">ğŸŒ CDN</option><option value="dns" data-glyph="ğŸ§­">ğŸ§­ DNS</option><option value="analytics_service" data-glyph="ğŸ“Š">ğŸ“Š Analytics</option><option value="ml_service" data-glyph="ğŸ¤–">ğŸ¤– ML Service</option><option value="security_shield" data-glyph="ğŸ›¡ï¸">ğŸ›¡ï¸ Security/Shield</option><option value="container" data-glyph="ğŸ“¦">ğŸ“¦ Container</option><option value="function_lambda" data-glyph="âš¡">âš¡ Function/Lambda</option><option value="virtual_machine" data-glyph="ğŸ’»">ğŸ’» Virtual Machine</option><option value="network_generic" data-glyph="ğŸ•¸ï¸">ğŸ•¸ï¸ Network</option><option value="user_group_icon" data-glyph="ğŸ‘¥">ğŸ‘¥ User Group</option><option value="data_pipeline" data-glyph="â¿">â¿ Data Pipeline</option><option value="service_generic" data-glyph="âš™ï¸">âš™ï¸ Service (Generic)</option><option value="monitor_dashboard" data-glyph="ğŸ“ˆ">ğŸ“ˆ Monitoring</option></optgroup>
        </select>
        <button id="tool-add-text" title="Add Text Mode">Add Text Mode</button>
        <label for="item-label-input">Label/Text:</label><input type="text" id="item-label-input" placeholder="Value" title="Text for items.">
        <button id="tool-add-item" title="Adds selected Item/Text.">Add Item/Text</button>
        <span style="margin:0 5px; border-left:1px solid #566f89; height: 20px;"></span>
        <label for="connector-style-select">Connector:</label>
        <select id="connector-style-select" title="Connector line style."><option value="straight">Straight</option><option value="curved">Curved</option><option value="elbow">Elbow</option><option value="rounded-elbow">Rounded Elbow</option></select>
        <button id="tool-connect" title="Connect Tool">Connect</button>
        <span style="margin:0 5px; border-left:1px solid #566f89; height: 20px;"></span>
        <button id="tool-shape-fill-toggle" title="Toggle fill/outline">Toggle Fill</button>
        <label for="shape-fill-color-input">Fill:</label><input type="color" id="shape-fill-color-input" value="#3498db" title="Fill color.">
        <button id="tool-send-back" title="Send selected item to back (Ctrl+Shift+Down)">To Back</button>
        <button id="tool-bring-front" title="Bring selected item to front (Ctrl+Shift+Up)">To Front</button>
        <span style="margin:0 5px; border-left:1px solid #566f89; height: 20px;"></span>
        <button id="tool-delete" title="Delete selected (Del)">Delete</button>
    </div>
    <div id="diagram-area"><svg id="diagram-canvas" xmlns="http://www.w3.org/2000/svg"><defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#566f89" /></marker><marker id="arrowhead-selected" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#f39c12" /></marker></defs></svg></div>

    <script>
        const svgCanvas = document.getElementById('diagram-canvas'); const ns = "http://www.w3.org/2000/svg"; const diagramArea = document.getElementById('diagram-area');
        let currentTool = 'select'; let items = []; let connectors = [];
        let selectedSvgElements = []; let selectedItemsData = []; let primarySelectedItemData = null;
        let connectingFromItem = null; let nextId = 0; let isDragging = false; let dragOffsetX, dragOffsetY;
        let isResizing = false; let resizeHandleType; let currentHoverResizeZone = null; const RESIZE_BORDER_SENSITIVITY = 10;
        let isDrawingSelectionRect = false; let selectionRectStart = {x: 0, y: 0}; let currentSelectionRectSvg = null;
        let history = []; let historyIndex = -1; const MAX_HISTORY_STATES = 20;
        const ARROW_OFFSET = 8; // Offset for arrowhead tip from boundary

        const toolButtons = {select:document.getElementById('tool-select'),resize:document.getElementById('tool-resize'),addText:document.getElementById('tool-add-text'),connect:document.getElementById('tool-connect')};
        const addItemBtn=document.getElementById('tool-add-item'); const deleteBtn=document.getElementById('tool-delete'); const shapeFillToggleBtn=document.getElementById('tool-shape-fill-toggle');
        const shapeTypeSelect=document.getElementById('shape-type-select'); const iconTypeSelect=document.getElementById('icon-type-select'); const itemLabelInput=document.getElementById('item-label-input');
        const connectorStyleSelect=document.getElementById('connector-style-select'); const shapeFillColorInput=document.getElementById('shape-fill-color-input');
        const undoBtn = document.getElementById('tool-undo'); const redoBtn = document.getElementById('tool-redo');
        const sendBackBtn = document.getElementById('tool-send-back'); const bringFrontBtn = document.getElementById('tool-bring-front');

        function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }
        function saveState() {if(isResizing||isDragging)return;const currState={items:deepClone(items),connectors:deepClone(connectors)};history=history.slice(0,historyIndex+1);history.push(currState);if(history.length>MAX_HISTORY_STATES)history.shift();historyIndex=history.length-1;updateUndoRedoButtons();}
        function undo(){if(historyIndex>0){historyIndex--;loadState(history[historyIndex]);updateUndoRedoButtons();}}
        function redo(){if(historyIndex<history.length-1){historyIndex++;loadState(history[historyIndex]);updateUndoRedoButtons();}}
        function loadState(state){items=deepClone(state.items);connectors=deepClone(state.connectors);clearAllSelection(false);renderDiagram();}
        function updateUndoRedoButtons(){undoBtn.disabled=historyIndex<=0;redoBtn.disabled=historyIndex>=history.length-1;}
        undoBtn.addEventListener('click',undo);redoBtn.addEventListener('click',redo);

        function setActiveTool(toolName){currentTool=toolName;connectingFromItem=null;isResizing=false;currentHoverResizeZone=null;Object.values(toolButtons).forEach(b=>b.classList.remove('active'));if(toolButtons[toolName])toolButtons[toolName].classList.add('active');svgCanvas.style.cursor='default';if(toolName==='connect')svgCanvas.style.cursor='crosshair';if(selectedSvgElements.length>0&&selectedSvgElements[0]&&selectedSvgElements[0].tagName==='g'){const mainSelectedElement=selectedSvgElements[0];const mainSelectedItem=primarySelectedItemData||selectedItemsData[0];if(toolName==='resize'&&mainSelectedItem&&!mainSelectedItem.isIcon&&mainSelectedItem.type!=='freeText'){addTemporaryItemListeners(mainSelectedElement,mainSelectedItem);}else{removeTemporaryItemListeners(mainSelectedElement);if(mainSelectedElement)mainSelectedElement.style.cursor=(toolName==='select')?'move':'pointer';}}updateToolbarForSelection();}
        Object.keys(toolButtons).forEach(k=>{if(toolButtons[k])toolButtons[k].addEventListener('click',()=>setActiveTool(k));});
        addItemBtn.addEventListener('click',addItemFromToolbar);deleteBtn.addEventListener('click',deleteSelected);shapeFillToggleBtn.addEventListener('click',toggleSelectedShapeFill);
        sendBackBtn.addEventListener('click',()=>moveZOrder(false));bringFrontBtn.addEventListener('click',()=>moveZOrder(true));
        setActiveTool('select');

        function addItemFromToolbar(){const sShapeVal=shapeTypeSelect.value;const selectedIconOption=iconTypeSelect.options[iconTypeSelect.selectedIndex];const sIV=selectedIconOption.value;const iG=selectedIconOption.dataset.glyph;const lT=itemLabelInput.value.trim();let iT,isI=false;if(currentTool==='addText'){iT='freeText';if(!lT){alert("Need text.");return;}}else{if(sIV){iT='icon';isI=true;}else if(sShapeVal){iT=sShapeVal;}else{alert("Select type.");return;}}const CTM=svgCanvas.getScreenCTM();const vCX=(diagramArea.scrollLeft+diagramArea.clientWidth/2)/(CTM?.a||1);const vCY=(diagramArea.scrollTop+diagramArea.clientHeight/2)/(CTM?.d||1);let aW=100,aH=60;const flowShapes=['diamond','parallelogram','oval','document','predefinedProcess','manualInput','manualOperation','internalStorage'];if(iT==='freeText'){aW=Math.max(80,lT.length*7+20);aH=25;}else if(isI){aW=60;aH=35+(lT?20:0);}else if(flowShapes.includes(iT)||iT==='rect'||iT==='circle'||iT==='db'){}createItem(iT,vCX-aW/2,vCY-aH/2,lT,isI,iG);if(currentTool!=='addText'){itemLabelInput.value="";shapeTypeSelect.value="";iconTypeSelect.value="";}else{itemLabelInput.value="";}}
        function createItem(type,x,y,label,isIcon,glyph){const id=`item-${nextId++}`;let dF='#3498db';if(type==='db')dF='#e74c3c';else if(type==='circle'||type==='oval')dF='#9b59b6';else if(type==='diamond')dF='#f1c40f';else if(type==='parallelogram')dF='#2ecc71';else if(type==='document')dF='#bdc3c7';else if(type==='predefinedProcess')dF='#e67e22';else if(type==='manualInput')dF='#5dade2';else if(type==='manualOperation')dF='#8e44ad';else if(type==='internalStorage')dF='#7f8c8d';let iD={id,type,x,y,label,isIcon,glyph,width:100,height:60,fillType:'filled',fillColor:dF};if(type==='freeText'){iD.width=Math.max(80,label.length*7+20);iD.height=25;}else if(isIcon){iD.width=60;iD.height=35+(label?20:0);}else if(type==='circle'||type==='oval'){iD.width=80;iD.height=50;}else if(type==='db'){iD.width=100;iD.height=50;}else if(type==='diamond'){iD.width=100;iD.height=70;}else if(type==='parallelogram'){iD.width=120;iD.height=60;}else if(type==='document'){iD.width=100;iD.height=70;}else if(type==='predefinedProcess'){iD.width=120;iD.height=60;}else if(type==='manualInput'){iD.width=120;iD.height=50;}else if(type==='manualOperation'){iD.width=100;iD.height=60;}else if(type==='internalStorage'){iD.width=100;iD.height=70;}items.push(iD);saveState();renderDiagram();const nE=svgCanvas.querySelector(`g[data-id="${id}"]`);if(nE)selectItem(nE,iD);}
        function createConnector(fId,tId){if(fId===tId)return;if(connectors.some(c=>(c.from===fId&&c.to===tId)||(c.from===tId&&c.to===fId)))return;const id=`conn-${nextId++}`;connectors.push({id,from:fId,to:tId,lineStyle:connectorStyleSelect.value});saveState();renderDiagram();}
        const tinycolor=(function(){function d(c,a=15){c=c.replace(/^#/,'');if(c.length===3)c=c[0]+c[0]+c[1]+c[1]+c[2]+c[2];let n=parseInt(c,16);let r=Math.max(0,(n>>16)-a);let g=Math.max(0,((n>>8)&0x00FF)-a);let b=Math.max(0,(n&0x0000FF)-a);return"#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1).padStart(6,'0');}function iL(c){c=c.replace(/^#/,'');if(c.length===3)c=c[0]+c[0]+c[1]+c[1]+c[2]+c[2];var r=parseInt(c.substring(0,2),16);var g=parseInt(c.substring(2,4),16);var b=parseInt(c.substring(4,6),16);return(r*0.299+g*0.587+b*0.114)>186;}return function(s){return{darken:(am)=>d(s,am),isLight:()=>iL(s),toString:()=>s};}})();

        // --- Anchor Point Logic (Revised for Boundary Connectors) ---
        function getItemAnchorPoints(itemData) { // Provides 8 anchor points
            const w = itemData.width; const h = itemData.height;
            return [
                { name: 'top-left', x: 0, y: 0 }, { name: 'top-center', x: w/2, y: 0 }, { name: 'top-right', x: w, y: 0 },
                { name: 'middle-left', x: 0, y: h/2 }, { name: 'middle-right', x: w, y: h/2 },
                { name: 'bottom-left', x: 0, y: h }, { name: 'bottom-center', x: w/2, y: h }, { name: 'bottom-right', x: w, y: h }
            ];
        }

        function getClosestAnchor(sourceItemData, targetItemData) {
            const sourceAnchors = getItemAnchorPoints(sourceItemData);
            let closestAnchor = sourceAnchors[0];
            let minDistance = Infinity;

            const targetCenterX = targetItemData.x + targetItemData.width / 2;
            const targetCenterY = targetItemData.y + targetItemData.height / 2;

            sourceAnchors.forEach(anchor => {
                const absAnchorX = sourceItemData.x + anchor.x;
                const absAnchorY = sourceItemData.y + anchor.y;
                const dx = absAnchorX - targetCenterX;
                const dy = absAnchorY - targetCenterY;
                const distance = dx * dx + dy * dy;
                if (distance < minDistance) {
                    minDistance = distance;
                    closestAnchor = anchor;
                }
            });
            return closestAnchor;
        }

        function renderDiagram(){const dE=svgCanvas.querySelector('defs');while(svgCanvas.childNodes.length>(dE?1:0)){if(svgCanvas.lastChild!==dE)svgCanvas.removeChild(svgCanvas.lastChild);else break;}if(dE&&svgCanvas.firstChild!==dE)svgCanvas.insertBefore(dE,svgCanvas.firstChild);
            connectors.forEach(conn=>{
                const fromItem=items.find(s=>s.id===conn.from); const toItem=items.find(s=>s.id===conn.to); if(!fromItem||!toItem)return;
                const startAnchorRel=getClosestAnchor(fromItem,toItem); const endAnchorRel=getClosestAnchor(toItem,fromItem);
                let x1=fromItem.x+startAnchorRel.x; let y1=fromItem.y+startAnchorRel.y;
                let x2=toItem.x+endAnchorRel.x; let y2=toItem.y+endAnchorRel.y;
                const angle=Math.atan2(y2-y1,x2-x1);
                const x2_offset=x2-ARROW_OFFSET*Math.cos(angle); const y2_offset=y2-ARROW_OFFSET*Math.sin(angle);
                // Slightly pull back start point as well, so line starts from edge for elbow/curved
                let x1_offset = x1; let y1_offset = y1;
                if (conn.lineStyle !== 'straight') { // Offset start point for non-straight lines
                     const angleStart = Math.atan2(y2_offset - y1, x2_offset - x1); // Use offsetted end point for angle
                     x1_offset = x1 + ARROW_OFFSET * 0.5 * Math.cos(angleStart); // Smaller offset
                     y1_offset = y1 + ARROW_OFFSET * 0.5 * Math.sin(angleStart);
                }

                let el;const eR=15;
                switch(conn.lineStyle){
                    case 'straight':el=document.createElementNS(ns,'line');el.setAttribute('x1',x1);el.setAttribute('y1',y1);el.setAttribute('x2',x2_offset);el.setAttribute('y2',y2_offset);break;
                    case 'curved':el=document.createElementNS(ns,'path');const dx=x2_offset-x1_offset,dy=y2_offset-y1_offset;const cOffsetX=-dy*0.25,cOffsetY=dx*0.25;el.setAttribute('d',`M ${x1_offset},${y1_offset} Q ${x1_offset+dx/2+cOffsetX},${y1_offset+dy/2+cOffsetY} ${x2_offset},${y2_offset}`);break;
                    case 'elbow':
                        el=document.createElementNS(ns,'path');
                        // Determine primary direction and create two segments. This logic can be complex.
                        // Simplified elbow: H-V or V-H based on dominant distance and anchor type
                        let pathString = `M ${x1_offset},${y1_offset} `;
                        if (startAnchorRel.name.includes('left') || startAnchorRel.name.includes('right')) { // Start horizontally
                            pathString += `L ${x2_offset},${y1_offset} L ${x2_offset},${y2_offset}`;
                        } else { // Start vertically
                            pathString += `L ${x1_offset},${y2_offset} L ${x2_offset},${y2_offset}`;
                        }
                        el.setAttribute('d',pathString);
                        break;
                    case 'rounded-elbow': // More complex for nice rounding - simplified as elbow for now
                        el=document.createElementNS(ns,'path');
                        // Placeholder: Uses sharp elbow logic for now
                        if (startAnchorRel.name.includes('left') || startAnchorRel.name.includes('right')) {
                            el.setAttribute('d', `M ${x1_offset},${y1_offset} L ${x2_offset},${y1_offset} L ${x2_offset},${y2_offset}`);
                        } else {
                            el.setAttribute('d', `M ${x1_offset},${y1_offset} L ${x1_offset},${y2_offset} L ${x2_offset},${y2_offset}`);
                        }
                        break;
                }
                if(el){el.setAttribute('class','connector');el.dataset.id=conn.id;const isConnSelected=selectedSvgElements.some(selEl=>selEl===el);if(isConnSelected)el.classList.add('selected-connector');svgCanvas.appendChild(el);}});
            items.forEach(item=>{const group=document.createElementNS(ns,'g');group.setAttribute('transform',`translate(${item.x},${item.y})`);group.dataset.id=item.id;group.dataset.itemType=item.type;let visualElement,hitAreaElement;let iW=item.width,iH=item.height;
                if(item.type==='freeText'){visualElement=document.createElementNS(ns,'text');visualElement.textContent=item.label;visualElement.setAttribute('x',0);visualElement.setAttribute('y',iH/2);visualElement.classList.add('free-text-visual');hitAreaElement=document.createElementNS(ns,'rect');hitAreaElement.setAttribute('width',iW);hitAreaElement.setAttribute('height',iH);hitAreaElement.setAttribute('fill','transparent');}
                else if(item.isIcon){hitAreaElement=document.createElementNS(ns,'rect');hitAreaElement.setAttribute('width',iW);hitAreaElement.setAttribute('height',iH);hitAreaElement.setAttribute('fill','transparent');visualElement=document.createElementNS(ns,'text');visualElement.textContent=item.glyph;visualElement.setAttribute('x',iW/2);visualElement.setAttribute('y',iH*(item.label?0.40:0.5));visualElement.classList.add('icon-glyph');if(item.label){const l=document.createElementNS(ns,'text');l.textContent=item.label;l.setAttribute('x',iW/2);l.setAttribute('y',iH*0.75);l.classList.add('icon-label');group.appendChild(l);}}
                else{visualElement=(()=>{let iconEl;switch(item.type){case 'rect':const r=document.createElementNS(ns,'rect');r.setAttribute('width',iW);r.setAttribute('height',iH);r.setAttribute('rx',8);return r;case 'circle':const c=document.createElementNS(ns,'circle');const rad=Math.min(iW,iH)/2;c.setAttribute('r',rad);c.setAttribute('cx',iW/2);c.setAttribute('cy',iH/2);return c;case 'db':const dbG=document.createElementNS(ns,'g');const dbB=document.createElementNS(ns,'rect');dbB.setAttribute('width',iW);dbB.setAttribute('height',iH);const dbT=document.createElementNS(ns,'ellipse');dbT.setAttribute('cx',iW/2);dbT.setAttribute('cy',0);dbT.setAttribute('rx',iW/2);dbT.setAttribute('ry',iH/3);[dbB,dbT].forEach(el=>{el.setAttribute('class','shape-visual');if(item.fillType==='filled'){el.style.fill=item.fillColor;el.style.stroke=tinycolor(item.fillColor).darken(15).toString();}else{el.style.fill='transparent';el.style.stroke=item.fillColor;el.classList.add('shape-outline');}});dbG.appendChild(dbT);dbG.appendChild(dbB);return dbG;case 'diamond':const dia=document.createElementNS(ns,'polygon');dia.setAttribute('points',`${iW/2},0 0,${iH/2} ${iW/2},${iH} ${iW},${iH/2}`);return dia;case 'parallelogram':const para=document.createElementNS(ns,'polygon');const paraSkew=iW*0.2;para.setAttribute('points',`${paraSkew},0 ${iW},0 ${iW-paraSkew},${iH} 0,${iH}`);return para;case 'oval':const ov=document.createElementNS(ns,'ellipse');ov.setAttribute('cx',iW/2);ov.setAttribute('cy',iH/2);ov.setAttribute('rx',iW/2);ov.setAttribute('ry',iH/2);return ov;case 'document':const doc=document.createElementNS(ns,'path');const curveHeight=iH*0.2;doc.setAttribute('d',`M0,0 L${iW},0 L${iW},${iH-curveHeight} Q${iW*0.75},${iH-curveHeight*2} ${iW*0.5},${iH-curveHeight} T0,${iH-curveHeight} L0,${iH-curveHeight} Z`);return doc;case 'predefinedProcess':const pp=document.createElementNS(ns,'rect');pp.setAttribute('width',iW);pp.setAttribute('height',iH);pp.setAttribute('rx',2);const ppL1=document.createElementNS(ns,'line');ppL1.setAttribute('x1',iW*0.1);ppL1.setAttribute('y1',0);ppL1.setAttribute('x2',iW*0.1);ppL1.setAttribute('y2',iH);ppL1.style.stroke=tinycolor(item.fillColor).darken(25).toString();ppL1.style.strokeWidth="2px";const ppL2=document.createElementNS(ns,'line');ppL2.setAttribute('x1',iW*0.9);ppL2.setAttribute('y1',0);ppL2.setAttribute('x2',iW*0.9);ppL2.setAttribute('y2',iH);ppL2.style.stroke=tinycolor(item.fillColor).darken(25).toString();ppL2.style.strokeWidth="2px";group.appendChild(ppL1);group.appendChild(ppL2);return pp;case 'manualInput':const mi=document.createElementNS(ns,'polygon');mi.setAttribute('points',`0,${iH*0.2} ${iW},0 ${iW},${iH} 0,${iH}`);return mi;case 'manualOperation':const mo=document.createElementNS(ns,'polygon');mo.setAttribute('points',`0,0 ${iW},0 ${iW-iW*0.2},${iH} ${iW*0.2},${iH}`);return mo;case 'internalStorage':const isR=document.createElementNS(ns,'rect');isR.setAttribute('width',iW);isR.setAttribute('height',iH);isR.setAttribute('rx',2);const isL1=document.createElementNS(ns,'line');isL1.setAttribute('x1',0);isL1.setAttribute('y1',iH*0.2);isL1.setAttribute('x2',iW);isL1.setAttribute('y2',iH*0.2);isL1.style.stroke=tinycolor(item.fillColor).darken(25).toString();isL1.style.strokeWidth="1.5px";const isL2=document.createElementNS(ns,'line');isL2.setAttribute('x1',iW*0.2);isL2.setAttribute('y1',0);isL2.setAttribute('x2',iW*0.2);isL2.setAttribute('y2',iH);isL2.style.stroke=tinycolor(item.fillColor).darken(25).toString();isL2.style.strokeWidth="1.5px";group.appendChild(isL1);group.appendChild(isL2);return isR;}})();hitAreaElement=visualElement;if(item.type!=='db'&&item.type!=='predefinedProcess'&&item.type!=='internalStorage'){visualElement.setAttribute('class','shape-visual');if(item.fillType==='filled'){visualElement.style.fill=item.fillColor;visualElement.style.stroke=tinycolor(item.fillColor).darken(15).toString();}else{visualElement.style.fill='transparent';visualElement.style.stroke=item.fillColor;visualElement.classList.add('shape-outline');}}else if(['db','predefinedProcess','internalStorage'].includes(item.type)){visualElement.querySelectorAll('.shape-visual').forEach(el=>{if(item.fillType==='filled'){el.style.fill=item.fillColor;el.style.stroke=tinycolor(item.fillColor).darken(15).toString();}else{el.style.fill='transparent';el.style.stroke=item.fillColor;el.classList.add('shape-outline');}});}if(item.label){const l=document.createElementNS(ns,'text');l.textContent=item.label;l.setAttribute('x',iW/2);l.setAttribute('y',iH/2);l.classList.add('main-text');if(item.fillType==='filled'&&!tinycolor(item.fillColor).isLight())l.classList.add('on-dark-shape');group.appendChild(l);}}
                if(hitAreaElement&&(item.type==='freeText'||item.isIcon)){group.appendChild(hitAreaElement);group.appendChild(visualElement);}else if(visualElement){group.appendChild(visualElement);}const isCurrentlySelected=selectedItemsData.some(selItem=>selItem.id===item.id);if(isCurrentlySelected){const isFilledType=!item.isIcon&&item.type!=='freeText'&&item.fillType==='filled';const elementToOutlineForSelection=(item.isIcon||item.type==='freeText'||item.fillType==='outline')?hitAreaElement:visualElement;if(item.isIcon||item.type==='freeText'||item.fillType==='outline'){if(elementToOutlineForSelection)elementToOutlineForSelection.classList.add('selected-outline');}else if(isFilledType){if(['db','queue','firewall','predefinedProcess','internalStorage'].includes(item.type))visualElement.querySelectorAll('.shape-visual').forEach(v=>v.classList.add('selected-filled-shape'));else visualElement.classList.add('selected-filled-shape');}}group.addEventListener('mousedown',onItemMouseDown);const isPrimaryForResize=primarySelectedItemData&&primarySelectedItemData.id===item.id;if(!(currentTool==='resize'&&isPrimaryForResize&&!item.isIcon&&item.type!=='freeText')){group.style.cursor=(currentTool==='select'&&(isCurrentlySelected||primarySelectedItemData?.id===item.id))?'move':(currentTool==='select'?'pointer':'default');}if(isPrimaryForResize&&currentTool==='resize'&&!item.isIcon&&item.type!=='freeText'){addTemporaryItemListeners(group,item);}else{removeTemporaryItemListeners(group);}svgCanvas.appendChild(group);});
        }
        let tempMouseMoveListener=null;let tempMouseLeaveListener=null;function addTemporaryItemListeners(iG,iD){removeTemporaryItemListeners(iG);if(!iG)return;tempMouseMoveListener=(e)=>manageResizeCursor(e,iG,iD);tempMouseLeaveListener=()=>{if(iG)iG.style.cursor=(currentTool==='select'&&selectedItemsData.some(d=>d.id===iD.id))?'move':'pointer';currentHoverResizeZone=null;};iG.addEventListener('mousemove',tempMouseMoveListener);iG.addEventListener('mouseleave',tempMouseLeaveListener);}
        function removeTemporaryItemListeners(iG){if(iG&&tempMouseMoveListener)iG.removeEventListener('mousemove',tempMouseMoveListener);if(iG&&tempMouseLeaveListener)iG.removeEventListener('mouseleave',tempMouseLeaveListener);tempMouseMoveListener=null;tempMouseLeaveListener=null;if(iG)iG.style.cursor=(currentTool==='select')?'move':'pointer';}
        function manageResizeCursor(e,iG,iD){if(currentTool!=='resize'||!iD||iD.isIcon||iD.type==='freeText'){if(iG)iG.style.cursor=(selectedItemsData.some(d=>d.id===iD.id)&&currentTool==='select')?'move':'pointer';svgCanvas.style.cursor='default';currentHoverResizeZone=null;return;}if(!e){if(iG)iG.style.cursor='move';currentHoverResizeZone=null;return;}const CTM=svgCanvas.getScreenCTM().inverse();const pt=svgCanvas.createSVGPoint();pt.x=e.clientX;pt.y=e.clientY;const svgP=pt.matrixTransform(CTM);const lX=svgP.x-iD.x;const lY=svgP.y-iD.y;let hZ=null;let nC='move';if(lX<RESIZE_BORDER_SENSITIVITY&&lY<RESIZE_BORDER_SENSITIVITY)hZ='top-left',nC='nwse-resize';else if(lX>iD.width-RESIZE_BORDER_SENSITIVITY&&lY<RESIZE_BORDER_SENSITIVITY)hZ='top-right',nC='nesw-resize';else if(lX<RESIZE_BORDER_SENSITIVITY&&lY>iD.height-RESIZE_BORDER_SENSITIVITY)hZ='bottom-left',nC='nesw-resize';else if(lX>iD.width-RESIZE_BORDER_SENSITIVITY&&lY>iD.height-RESIZE_BORDER_SENSITIVITY)hZ='bottom-right',nC='nwse-resize';else if(lX<RESIZE_BORDER_SENSITIVITY)hZ='left-mid',nC='ew-resize';else if(lX>iD.width-RESIZE_BORDER_SENSITIVITY)hZ='right-mid',nC='ew-resize';else if(lY<RESIZE_BORDER_SENSITIVITY)hZ='top-mid',nC='ns-resize';else if(lY>iD.height-RESIZE_BORDER_SENSITIVITY)hZ='bottom-mid',nC='ns-resize';if(iG)iG.style.cursor=nC;currentHoverResizeZone=hZ;}
        function onItemMouseDown(e){e.stopPropagation();const g=e.currentTarget;const d=items.find(it=>it.id===g.dataset.id);if(!d)return;isDragging=false;isResizing=false;const isAlreadySelected=selectedItemsData.some(msd=>msd.id===d.id);if(currentTool==='resize'&&currentHoverResizeZone&&((primarySelectedItemData===d&&selectedItemsData.length<=1)||(isAlreadySelected&&selectedItemsData.length===1))&&!d.isIcon&&d.type!=='freeText'){setPrimarySelection(g,d,selectedItemsData);isResizing=true;resizeHandleType=currentHoverResizeZone;}else if(currentTool==='select'){if(e.shiftKey){toggleMultiSelectItem(g,d);}else if(!isAlreadySelected){setPrimarySelection(g,d,[d]);}else{setPrimarySelection(g,d,selectedItemsData);}isDragging=true;const CTM=svgCanvas.getScreenCTM();const pt=svgCanvas.createSVGPoint();pt.x=e.clientX;pt.y=e.clientY;const svgP=pt.matrixTransform(CTM.inverse());dragOffsetX=svgP.x-(primarySelectedItemData?.x||d.x);dragOffsetY=svgP.y-(primarySelectedItemData?.y||d.y);}else if(currentTool==='connect'){if(!connectingFromItem){connectingFromItem=d;setPrimarySelection(g,d,[d]);}else{if(connectingFromItem.id!==d.id)createConnector(connectingFromItem.id,d.id);connectingFromItem=null;}}renderDiagram();updateToolbarForSelection();}
        svgCanvas.addEventListener('mousedown',(e)=>{if(e.target===svgCanvas&&currentTool==='select'){isDrawingSelectionRect=true;selectionRectStart=getSvgCoordinates(e);clearAllSelection(false);renderDiagram();currentSelectionRectSvg=document.createElementNS(ns,'rect');currentSelectionRectSvg.setAttribute('id','selection-rectangle');currentSelectionRectSvg.setAttribute('x',selectionRectStart.x);currentSelectionRectSvg.setAttribute('y',selectionRectStart.y);svgCanvas.appendChild(currentSelectionRectSvg);}else if(e.target.classList.contains('connector')&&currentTool==='select'){selectConnector(e.target);}else if(e.target===svgCanvas){clearAllSelection();}updateToolbarForSelection();});
        svgCanvas.addEventListener('mousemove',(e)=>{const CTM=svgCanvas.getScreenCTM();const pt=svgCanvas.createSVGPoint();pt.x=e.clientX;pt.y=e.clientY;const svgP=pt.matrixTransform(CTM.inverse());if(isDrawingSelectionRect&&currentSelectionRectSvg){const w=svgP.x-selectionRectStart.x;const h=svgP.y-selectionRectStart.y;currentSelectionRectSvg.setAttribute('width',Math.abs(w));currentSelectionRectSvg.setAttribute('height',Math.abs(h));currentSelectionRectSvg.setAttribute('x',w<0?svgP.x:selectionRectStart.x);currentSelectionRectSvg.setAttribute('y',h<0?svgP.y:selectionRectStart.y);}else if(isDragging&&primarySelectedItemData&&selectedItemsData.length>0){const deltaX=svgP.x-dragOffsetX-primarySelectedItemData.x;const deltaY=svgP.y-dragOffsetY-primarySelectedItemData.y;selectedItemsData.forEach(itemData=>{itemData.x+=deltaX;itemData.y+=deltaY;});renderDiagram();}else if(isResizing&&primarySelectedItemData){let nX=primarySelectedItemData.x,nY=primarySelectedItemData.y,nW=primarySelectedItemData.width,nH=primarySelectedItemData.height;const pR=primarySelectedItemData.x+primarySelectedItemData.width,pB=primarySelectedItemData.y+primarySelectedItemData.height;if(resizeHandleType.includes('right'))nW=Math.max(20,svgP.x-primarySelectedItemData.x);if(resizeHandleType.includes('bottom'))nH=Math.max(20,svgP.y-primarySelectedItemData.y);if(resizeHandleType.includes('left')){nW=Math.max(20,pR-svgP.x);nX=svgP.x;}if(resizeHandleType.includes('top')){nH=Math.max(20,pB-svgP.y);nY=svgP.y;}if(resizeHandleType==='top-mid'){nH=Math.max(20,pB-svgP.y);nY=svgP.y;}if(resizeHandleType==='bottom-mid'){nH=Math.max(20,svgP.y-primarySelectedItemData.y);}if(resizeHandleType==='left-mid'){nW=Math.max(20,pR-svgP.x);nX=svgP.x;}if(resizeHandleType==='right-mid'){nW=Math.max(20,svgP.x-primarySelectedItemData.x);}if(primarySelectedItemData.type==='circle'){let mX=(svgP.x-(primarySelectedItemData.x+primarySelectedItemData.width/2));let mY=(svgP.y-(primarySelectedItemData.y+primarySelectedItemData.height/2));let dC=Math.sqrt(mX*mX+mY*mY)*2;nW=nH=Math.max(20,dC);nX=primarySelectedItemData.x+primarySelectedItemData.width/2-nW/2;nY=primarySelectedItemData.y+primarySelectedItemData.height/2-nH/2;}primarySelectedItemData.x=nX;primarySelectedItemData.y=nY;primarySelectedItemData.width=nW;primarySelectedItemData.height=nH;renderDiagram();}});
        svgCanvas.addEventListener('mouseup',(e)=>{if(isDrawingSelectionRect&&currentSelectionRectSvg){const CTM=svgCanvas.getScreenCTM();const pt=svgCanvas.createSVGPoint();pt.x=e.clientX;pt.y=e.clientY;const finalMousePos=pt.matrixTransform(CTM.inverse());const selRect={x:Math.min(selectionRectStart.x,finalMousePos.x),y:Math.min(selectionRectStart.y,finalMousePos.y),width:Math.abs(finalMousePos.x-selectionRectStart.x),height:Math.abs(finalMousePos.y-selectionRectStart.y)};selectedItemsData=[];selectedSvgElements=[];items.forEach(item=>{const itemBBox={x:item.x,y:item.y,width:item.width,height:item.height};if(rectsIntersect(selRect,itemBBox)){selectedItemsData.push(item);const svgEl=svgCanvas.querySelector(`g[data-id='${item.id}']`);if(svgEl)selectedSvgElements.push(svgEl);}});primarySelectedItemData=selectedItemsData.length>0?selectedItemsData[0]:null;svgCanvas.removeChild(currentSelectionRectSvg);currentSelectionRectSvg=null;isDrawingSelectionRect=false;saveState();renderDiagram();}const SElPrimary=selectedSvgElements.length>0?selectedSvgElements.find(el=>el.dataset.id===primarySelectedItemData?.id):null;const IDatPrimary=primarySelectedItemData;let wasDraggingOrResizing=isDragging||isResizing;isDragging=false;isResizing=false;svgCanvas.style.cursor='default';currentHoverResizeZone=null;if(currentTool==='resize'&&SElPrimary&&IDatPrimary&&SElPrimary.tagName==='g'){manageResizeCursor({clientX:0,clientY:0},SElPrimary,IDatPrimary);}else if(SElPrimary&&SElPrimary.tagName==='g'){SElPrimary.style.cursor=(currentTool==='select')?'move':'pointer';}updateToolbarForSelection();if(!isDrawingSelectionRect&&(wasDraggingOrResizing))saveState();});
        svgCanvas.addEventListener('mouseleave',()=>{if(isDrawingSelectionRect){isDrawingSelectionRect=false;if(currentSelectionRectSvg)svgCanvas.removeChild(currentSelectionRectSvg);currentSelectionRectSvg=null;}if(isDragging||isResizing){isDragging=false;isResizing=false;svgCanvas.style.cursor='default';currentHoverResizeZone=null;saveState();renderDiagram();}});
        function getSvgCoordinates(event){const CTM=svgCanvas.getScreenCTM();const pt=svgCanvas.createSVGPoint();pt.x=event.clientX;pt.y=event.clientY;return pt.matrixTransform(CTM.inverse());}
        function rectsIntersect(r1,r2){return!(r2.x>r1.x+r1.width||r2.x+r2.width<r1.x||r2.y>r1.y+r1.height||r2.y+r2.height<r1.y);}
        function selectItem(svgEl,itemDataObj){if(!svgEl&&!itemDataObj&&selectedSvgElements.length===0&&selectedItemsData.length===0)return;if(!itemDataObj)itemDataObj=items.find(i=>i.id===svgEl.dataset.id);clearAllSelection(false);selectedSvgElements=[svgEl];selectedItemsData=[itemDataObj];primarySelectedItemData=itemDataObj;if(currentTool==='resize'&&primarySelectedItemData&&!primarySelectedItemData.isIcon&&primarySelectedItemData.type!=='freeText'){addTemporaryItemListeners(svgEl,primarySelectedItemData);}else{removeTemporaryItemListeners(svgEl);}renderDiagram();updateToolbarForSelection();}
        function selectConnector(cSvgE){clearAllSelection(false);selectedSvgElements=[cSvgE];selectedItemsData=[];primarySelectedItemData=null;removeTemporaryItemListeners(cSvgE);renderDiagram();updateToolbarForSelection();}
        function toggleMultiSelectItem(svgEl,itemData){const index=selectedItemsData.findIndex(d=>d.id===itemData.id);if(index>-1){selectedItemsData.splice(index,1);selectedSvgElements.splice(selectedSvgElements.findIndex(el=>el.dataset.id===itemData.id),1);if(primarySelectedItemData&&primarySelectedItemData.id===itemData.id){primarySelectedItemData=selectedItemsData.length>0?selectedItemsData[0]:null;}}else{selectedItemsData.push(itemData);selectedSvgElements.push(svgEl);if(!primarySelectedItemData)primarySelectedItemData=itemData;}}
        function setPrimarySelection(svgEl,itemData,currentMultiSelData=[]){const currentMultiSelectDataValidated=Array.isArray(currentMultiSelData)?currentMultiSelData:[];selectedSvgElements=[svgEl,...currentMultiSelectDataValidated.filter(d=>d.id!==itemData.id).map(d=>svgCanvas.querySelector(`g[data-id='${d.id}']`)).filter(el=>el)];selectedItemsData=[itemData,...currentMultiSelectDataValidated.filter(d=>d.id!==itemData.id)];primarySelectedItemData=itemData;}
        function clearAllSelection(tR=true){selectedSvgElements.forEach(el=>{if(el&&el.tagName==='g')removeTemporaryItemListeners(el);});selectedSvgElements=[];selectedItemsData=[];primarySelectedItemData=null;if(tR)renderDiagram();updateToolbarForSelection();}
        function deleteSelected(){let changed=false;if(selectedItemsData.length>0){selectedItemsData.forEach(itemData=>{items=items.filter(s=>s.id!==itemData.id);connectors=connectors.filter(c=>c.from!==itemData.id&&c.to!==itemData.id);});changed=true;}else if(selectedSvgElements.length>0&&selectedSvgElements[0]?.dataset.id?.startsWith('conn-')){const idDel=selectedSvgElements[0].dataset.id;connectors=connectors.filter(c=>c.id!==idDel);changed=true;}if(!changed&&primarySelectedItemData){const idDel=primarySelectedItemData.id;items=items.filter(s=>s.id!==idDel);connectors=connectors.filter(c=>c.from!==idDel&&c.to!==idDel);changed=true;}if(!changed)return;saveState();clearAllSelection();updateToolbarForSelection();}
        function toggleSelectedShapeFill(){let changed=false;const targets=selectedItemsData.length>0?selectedItemsData:(primarySelectedItemData?[primarySelectedItemData]:[]);targets.forEach(sD=>{if(sD&&!sD.isIcon&&sD.type!=='freeText'){sD.fillType=(sD.fillType==='filled')?'outline':'filled';changed=true;}});if(changed){saveState();renderDiagram();updateToolbarForSelection();}}
        shapeFillColorInput.addEventListener('input',(e)=>{let changed=false;const targets=selectedItemsData.length>0?selectedItemsData:(primarySelectedItemData?[primarySelectedItemData]:[]);targets.forEach(sD=>{if(sD&&!sD.isIcon&&sD.type!=='freeText'&&sD.fillType==='filled'){sD.fillColor=e.target.value;changed=true;}});if(changed){saveState();renderDiagram();updateToolbarForSelection();}});
        connectorStyleSelect.addEventListener('change',(e)=>{if(selectedSvgElements.length===1&&selectedSvgElements[0]?.dataset.id?.startsWith('conn-')){const cD=connectors.find(c=>c.id===selectedSvgElements[0].dataset.id);if(cD){cD.lineStyle=e.target.value;saveState();renderDiagram();const rS=svgCanvas.querySelector(`[data-id="${cD.id}"]`);if(rS)selectConnector(rS);}}});
        function moveZOrder(toFront){if(!primarySelectedItemData)return;const currIdx=items.findIndex(item=>item.id===primarySelectedItemData.id);if(currIdx===-1)return;const iToMove=items.splice(currIdx,1)[0];if(toFront)items.push(iToMove);else items.unshift(iToMove);saveState();renderDiagram();const newSvgEl=svgCanvas.querySelector(`g[data-id='${iToMove.id}']`);if(newSvgEl){const reselectedItemData=items.find(it=>it.id===iToMove.id);if(reselectedItemData)selectItem(newSvgEl,reselectedItemData);}}
        function updateToolbarForSelection(){const singleItemSelected=primarySelectedItemData&&selectedItemsData.length<=1;const itemsActuallySelected=selectedItemsData.length>0;const connectorSelected=selectedSvgElements.length===1&&selectedSvgElements[0]?.dataset.id?.startsWith('conn-');toolButtons.resize.disabled=!(singleItemSelected&&primarySelectedItemData&&!primarySelectedItemData.isIcon&&primarySelectedItemData.type!=='freeText');shapeFillToggleBtn.disabled=!(itemsActuallySelected&&selectedItemsData.every(d=>!d.isIcon&&d.type!=='freeText'));shapeFillColorInput.disabled=!(itemsActuallySelected&&selectedItemsData.every(d=>!d.isIcon&&d.type!=='freeText'&&d.fillType==='filled'));sendBackBtn.disabled=!singleItemSelected;bringFrontBtn.disabled=!singleItemSelected;deleteBtn.disabled=!itemsActuallySelected&&!connectorSelected;if(singleItemSelected&&primarySelectedItemData&&!primarySelectedItemData.isIcon&&primarySelectedItemData.type!=='freeText'){shapeFillToggleBtn.textContent=primarySelectedItemData.fillType==='filled'?"Set Outline":"Set Filled";if(primarySelectedItemData.fillType==='filled')shapeFillColorInput.value=primarySelectedItemData.fillColor||'#000000';}else if(itemsActuallySelected&&selectedItemsData.every(d=>!d.isIcon&&d.type!=='freeText')){let commonFillType=selectedItemsData[0]?.fillType;let consistentFill=selectedItemsData.every(d=>d.fillType === commonFillType);shapeFillToggleBtn.textContent=consistentFill?(commonFillType==='filled'?"Set Outline":"Set Filled"):"Toggle Fill";}else{shapeFillToggleBtn.textContent="Toggle Fill";}const isConnTool=currentTool==='connect';connectorStyleSelect.disabled=!(isConnTool||connectorSelected);if(connectorSelected){const cn=connectors.find(c=>c.id===selectedSvgElements[0].dataset.id);if(cn)connectorStyleSelect.value=cn.lineStyle;}updateUndoRedoButtons();}

        saveState();renderDiagram();updateToolbarForSelection();
    </script>
</body>
</html>